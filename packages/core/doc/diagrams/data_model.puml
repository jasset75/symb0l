@startuml DataModel
skinparam linetype ortho
skinparam nodesep 80
skinparam ranksep 80


package "Core Domain" {
  entity "Instrument" as instrument {
    *instrument_id : INTEGER <<PK>>
    --
    isin : TEXT <<UQ, nullable>>
    *name : TEXT
    *instrument_type_id : INTEGER <<FK>>
    profile_id : INTEGER <<FK>>
    risk_level_id : INTEGER <<FK>>
    asset_class_level_id : INTEGER <<FK>>
    market_cap_id : INTEGER <<FK>>
    sector_id : INTEGER <<FK>>
    sub_industry_id : INTEGER <<FK>>
    country_exposure_id : INTEGER <<FK>>
  }

  entity "Listing" as listing {
    *listing_id : INTEGER <<PK>>
    --
    *instrument_id : INTEGER <<FK>>
    *market_id : INTEGER <<FK>>
    *symbol_code : TEXT
    currency_id : TEXT <<FK>>
  }

  entity "Market" as market {
    *market_id : INTEGER <<PK>>
    --
    *mic_code : TEXT <<UQ>>
    ticker_prefix : TEXT
    *name : TEXT
    title : TEXT
    *country_code : TEXT <<FK>>
    timezone : TEXT
  }

  entity "Country" as country {
    *country_code : TEXT <<PK>>
    --
    *name : TEXT
  }

  entity "Currency" as currency {
    *currency_id : TEXT <<PK>>
    --
    *name : TEXT
    *code3 : TEXT
    *code2 : TEXT
    *currency_symbol : TEXT
    *decimal_digits : INTEGER
  }
}

package "Metadata Classifications" {
  entity "Profile" as profile {
    *profile_id : INTEGER <<PK>>
    --
    *name : TEXT <<UQ>>
  }

  entity "RiskLevel" as risk_level {
    *risk_level_id : INTEGER <<PK>>
    --
    *name : TEXT <<UQ>>
    *weight : INTEGER
  }

  entity "AssetClassLevel" as asset_class_level {
    *asset_class_level_id : INTEGER <<PK>>
    --
    *name : TEXT <<UQ>>
    description : TEXT
  }

  entity "MarketCap" as market_cap {
    *market_cap_id : INTEGER <<PK>>
    --
    *name : TEXT <<UQ>>
  }

  entity "Sector" as sector {
    *sector_id : INTEGER <<PK>>
    --
    *name : TEXT <<UQ>>
    description : TEXT
  }

  entity "SubIndustry" as sub_industry {
    *sub_industry_id : INTEGER <<PK>>
    --
    *name : TEXT <<UQ>>
    description : TEXT
  }

  entity "CountryExposure" as country_exposure {
    *country_exposure_id : INTEGER <<PK>>
    --
    *name : TEXT <<UQ>>
  }

  entity "InstrumentType" as instrument_type {
    *instrument_type_id : INTEGER <<PK>>
    --
    *name : TEXT <<UQ>>
  }
}

entity "view_listings" as view_listings <<view>> {
  listing_id : INTEGER
  symbol_code : TEXT
  instrument_name : TEXT
  instrument_type : TEXT
  market_name : TEXT
  market_mic : TEXT
  market_timezone : TEXT
  country_code : TEXT
  country_name : TEXT
  currency_code : TEXT
  currency_symbol : TEXT
}

' Core Relationships - enforce vertical hierarchy
country ||..d|{ market
market ||..d|{ listing
instrument ||..r|{ listing
currency ||..u|{ listing

listing ..> view_listings : projects

' Metadata relationships - place below instrument
instrument }o..d|| profile
instrument }o..d|| risk_level
instrument }o..d|| asset_class_level
instrument }o..d|| market_cap
instrument }o..d|| sector
instrument }o..d|| sub_industry
instrument }o..d|| sub_industry
instrument }o..d|| country_exposure
instrument }o..l|| instrument_type

' Layout hints
profile -[hidden]r- risk_level
risk_level -[hidden]r- asset_class_level
asset_class_level -[hidden]r- market_cap
market_cap -[hidden]r- sector
sector -[hidden]r- sub_industry
sub_industry -[hidden]r- country_exposure

note right of country
  ISO 3166-1 alpha-2
  (US, ES, FR, JP, etc.)
end note

note right of market
  Dual-code system:
  • mic_code: ISO 10383 (XNAS)
  • ticker_prefix: Google Finance (NASDAQ)
end note

note right of instrument
  ISIN nullable for
  forex and crypto
end note

@enduml
